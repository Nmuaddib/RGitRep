{
    "collab_server" : "",
    "contents" : "---\ntitle: ''\nauthor: \"Nelson Simões - CTI/Planserv\"\ndate: \"7 de agosto de 2017\"\noutput:\n  html_document:\n    code_folding: hide\n    theme: cerulean\n    highlight: pygments\n---\n\n## Preparação\n\n```{r setup, include=TRUE, message=FALSE, warning=FALSE}\nknitr::opts_chunk$set(\n\techo = TRUE,\n\tmessage = FALSE,\n\twarning = FALSE\n)\nlibrary(\"stringr\", lib.loc=\"~/R/win-library/3.4\")\nlibrary(\"dplyr\", lib.loc=\"~/R/win-library/3.4\")\nlibrary(\"ggplot2\", lib.loc=\"~/R/win-library/3.4\")\nlibrary(\"readr\", lib.loc=\"~/R/win-library/3.4\")\nlibrary(\"tibble\", lib.loc=\"~/R/win-library/3.4\")\nlibrary(\"tidyr\", lib.loc=\"~/R/win-library/3.4\")\nlibrary(\"reshape2\", lib.loc=\"~/R/win-library/3.4\")\nlibrary(\"magrittr\", lib.loc=\"~/R/win-library/3.4\")\nlibrary(\"readxl\", lib.loc=\"~/R/win-library/3.4\")\nlibrary(\"modelr\", lib.loc=\"~/R/win-library/3.4\")\nlibrary(\"purrr\", lib.loc=\"~/R/win-library/3.4\")\nlibrary(\"forcats\", lib.loc=\"~/R/win-library/3.4\")\n\ncai <- read_excel('CAIv2.xlsx') %>% # readxl: importação\n  group_by(componente,internacao,amq) %>% # dplyr: agrupamento\n  summarise(valor = sum(valor), qt = sum(quantidade)) %>% # dplyr: sumarização\n  select(-valor) %>% # dplyr: retirada de uma coluna\n  spread(componente,qt) %>% # tidyr: mudança de formato, de chave-valor para colunas\n  arrange(amq, internacao) %>%  # dplyr: reordenação\n  filter(amq>=\"20140101\"); # dplyr: seleção;\n\ncai_df <- cai %>% \n  as.data.frame() %>% \n  mutate(semestre = paste0(str_sub(amq,1,4),ifelse(str_sub(amq,5,6) > '06','02','01'))) %>% \n  as.tibble()\n\nf.tab_cor <-  function(caidf,mtd) {\n  corP <- caidf %>%  \n    group_by(amq) %>% \n    summarise(consulta = sum(consulta, na.rm = TRUE), \n              domiciliar = sum(domiciliar, na.rm = TRUE), \n              emergencia = sum(emergencia, na.rm = TRUE), \n              honorario = sum(honorario, na.rm = TRUE), \n              material = sum(material, na.rm = TRUE), \n              medicamento = sum(medicamento, na.rm = TRUE), \n              nulo = sum(nulo, na.rm = TRUE), \n              pacote = sum(pacote, na.rm = TRUE), \n              remocao = sum(remocao, na.rm = TRUE), \n              sadt = sum(sadt, na.rm = TRUE), \n              taxa = sum(taxa, na.rm = TRUE)) %>% \n    as.data.frame(.) %>%\n    select(-amq) %>% \n    as.tibble() %>% \n    cor(., method = mtd)\n}\n\ncaiN.corP <- cai %>%\n  filter(internacao == 'n') %>% \n  arrange(amq) %>%\n  f.tab_cor(.,'pearson')\n\ncaiS.corP <- cai %>%\n  filter(internacao == 's') %>% \n  arrange(amq) %>% \n  f.tab_cor(.,'pearson')\n\nf.sel_cai_var <- function(var_n, ind_int) {\n  cai_df %>%\n    filter(internacao == ind_int) %>% \n    arrange(amq) %>% \n    select(var_n) %>% \n    as.tibble()  \n}\n\ncai_ECn_PTs.corP <- cbind(f.sel_cai_var(c('emergencia', 'consulta'), 'n'),\n                          f.sel_cai_var(c('taxa', 'pacote'), 's')) %>% \n  .[1:77,] %>% \n  cor(., method = 'pearson')\n\nf.cor_smst <- function(df,x,y) {\n  tb = tibble(semestre = character(), corr = character())\n  for(i in seq_along(df)) {\n    tb[i,] <- cbind(names(df)[i],df[[i]][x,y])\n  }\n\n  tb %<>%  mutate(semestre = factor(semestre,levels = semestre), corr = as.double(corr)) %>% \n    return()\n}\n\nf.cor_cmpar <- function(df,dfcor,x,y) {\n  print(paste(x,y))\n  print('-------------------------------------------------------------')  \n  print(f.cor_smst(dfcor, x, y))\n  corr <- as.numeric(f.cor_smst(dfcor, x, y)$corr)\n  print('-------------------------------------------------------------')\n  print(paste0('Range:              ', range(corr)[1], ' > ', range(corr)[2]))\n  print(paste0('Prop(Max) Perc Var: ', round((range(corr)[2]-range(corr)[1])/range(corr)[2],4)*100))\n  print(paste0('Mean Corr:          ', mean(corr)))\n  print(paste0('Main Corr:          ', df[x, y]))\n  print(paste0('Delta Corr:         ', abs(mean(corr)-df[x, y])))\n  print(paste0('Var:                ', var(corr)))\n  print(paste0('DP:                 ', sd(corr)))\n  print('-------------------------------------------------------------')  \n  ggplot(data = f.cor_smst(dfcor, x, y),\n                  aes(x = semestre, y = as.numeric(corr))) +\n    geom_point(col = 'orange', size = 3) +\n    geom_line(color = 'blue', size = 1, alpha = 0.5, group = 1) +\n    geom_hline(yintercept = 1, col = 'green', alpha = 0.8) +\n    geom_hline(yintercept = 0.75, col = 'red', alpha = 0.3) +    \n    geom_hline(yintercept = 0, col = 'black', alpha = 0.3) + \n    labs(title = 'Correlações Semestrais', x = 'Semestres', y = 'Correlação') + \n    scale_y_continuous(breaks = seq(-0.5, 1.0, by = 0.1)) +\n    coord_cartesian(ylim=c(-0.5, 1.0)) +\n    theme_bw()  \n}\n\nsmstN.corP <- cai_df %>% \n  filter(internacao == 'n') %>% \n  arrange(amq) %>%  \n  split(.$semestre) %>% \n  map(f.tab_cor,'pearson')#;smstN.corP\n\nsmstS.corP <- cai_df %>% \n  filter(internacao == 's') %>% \n  arrange(amq) %>%  \n  split(.$semestre) %>% \n  map(f.tab_cor,'pearson')#;smstS.corP\n\nsmst_cross.corP <- cbind(f.sel_cai_var(c('emergencia', 'consulta'), 'n'),\n                    f.sel_cai_var(c('taxa', 'pacote','semestre'), 's')) %>%   \n  .[1:77,] %>% \n  split(.$semestre) %>%\n  map(select,-semestre) %>%\n  map(cor, method = 'pearson')#;smst_cross.corP\n\nprint(\"Abra o código com o botão à direta e acima\")\n\n```\n\n## Análise\n\n---\n\n**Correlações mais relevantes em ambulatório:**\n```{r resultados N, echo=FALSE, fig.height=7, fig.width=10}\nf.cor_cmpar(caiN.corP,smstN.corP,'consulta','sadt')\nf.cor_cmpar(caiN.corP,smstN.corP,'sadt','pacote')\nf.cor_cmpar(caiN.corP,smstN.corP,'consulta','honorario')\nf.cor_cmpar(caiN.corP,smstN.corP,'honorario','medicamento')\n```\n\n---\n\n**Correlações cruzadas mais relevantes:**\n```{r resultados C, echo=FALSE, fig.height=7, fig.width=10}\nf.cor_cmpar(cai_ECn_PTs.corP,smst_cross.corP,'emergencia','taxa')\nf.cor_cmpar(cai_ECn_PTs.corP,smst_cross.corP,'consulta','pacote')\n```\n\n---\n\n**Correlações mais relevantes em Internação:**\n```{r resultados S, echo=FALSE, fig.height=7, fig.width=10}\nf.cor_cmpar(caiS.corP,smstS.corP,'pacote','honorario')\nf.cor_cmpar(caiS.corP,smstS.corP,'taxa','honorario')\nf.cor_cmpar(caiS.corP,smstS.corP,'taxa','sadt')\nf.cor_cmpar(caiS.corP,smstS.corP,'taxa','material')\nf.cor_cmpar(caiS.corP,smstS.corP,'honorario','medicamento')\nf.cor_cmpar(caiS.corP,smstS.corP,'sadt','medicamento')\n```\n",
    "created" : 1502118623995.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "3123703569",
    "id" : "B8EBCB4",
    "lastKnownWriteTime" : 1502208623,
    "last_content_update" : 1502208623384,
    "path" : "~/R/Estudo_Componente_Geral/Correlação Semestral.Rmd",
    "project_path" : "Correlação Semestral.Rmd",
    "properties" : {
        "last_setup_crc32" : "",
        "tempName" : "Untitled1"
    },
    "relative_order" : 3,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_markdown"
}