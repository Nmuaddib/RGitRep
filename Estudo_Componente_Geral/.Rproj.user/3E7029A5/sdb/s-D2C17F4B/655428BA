{
    "collab_server" : "",
    "contents" : "library(\"stringr\", lib.loc=\"~/R/win-library/3.4\")\nlibrary(\"tidyverse\", lib.loc=\"~/R/win-library/3.4\")\nlibrary(\"reshape2\", lib.loc=\"~/R/win-library/3.4\")\nlibrary(\"readxl\", lib.loc=\"~/R/win-library/3.4\")\nlibrary(\"modelr\", lib.loc=\"~/R/win-library/3.4\")\nlibrary(\"purrr\", lib.loc=\"~/R/win-library/3.4\")\nlibrary(\"forcats\", lib.loc=\"~/R/win-library/3.4\")\n\n#----------------------------------------------------------------------------------\ncai <- read_excel('CAIv2.xlsx') %>% # readxl: importação\n  group_by(componente,internacao,amq) %>% # dplyr: agrupamento\n  summarise(valor = sum(valor), qt = sum(quantidade)) %>% # dplyr: sumarização\n  select(-valor) %>% # dplyr: retirada de uma coluna\n  spread(componente,qt) %>% # tidyr: mudança de formato, de chave-valor para colunas\n  arrange(amq, internacao) %>%  # dplyr: reordenação\n  filter(amq>=\"20140101\"); cai; # dplyr: seleção;\n\ncai_df <- cai %>% \n  as.data.frame() %>% \n  mutate(semestre = paste0(str_sub(amq,1,4),ifelse(str_sub(amq,5,6) > '06','02','01'))) %>% \n  as.tibble()\n\nf.tab_cor <-  function(caidf,mtd) {\n  corP <- caidf %>%  \n    group_by(amq) %>% \n    summarise(consulta = sum(consulta, na.rm = TRUE), \n              domiciliar = sum(domiciliar, na.rm = TRUE), \n              emergencia = sum(emergencia, na.rm = TRUE), \n              honorario = sum(honorario, na.rm = TRUE), \n              material = sum(material, na.rm = TRUE), \n              medicamento = sum(medicamento, na.rm = TRUE), \n              nulo = sum(nulo, na.rm = TRUE), \n              pacote = sum(pacote, na.rm = TRUE), \n              remocao = sum(remocao, na.rm = TRUE), \n              sadt = sum(sadt, na.rm = TRUE), \n              taxa = sum(taxa, na.rm = TRUE)) %>% \n    as.data.frame(.) %>%\n    select(-amq) %>% \n    as.tibble() %>% \n    cor(., method = mtd)\n}\n\ncaiN.corP <- cai %>%\n  filter(internacao == 'n') %>% \n  arrange(amq) %>%\n  f.tab_cor(.,'pearson')\n\ncaiS.corP <- cai %>%\n  filter(internacao == 's') %>% \n  arrange(amq) %>% \n  f.tab_cor(.,'pearson')\n\nf.sel_cai_var <- function(var_n, ind_int) {\n  cai_df %>%\n    filter(internacao == ind_int) %>% \n    arrange(amq) %>% \n    select(var_n) %>% \n    as.tibble()  \n}\n\ncai_ECn_PTs.corP <- cbind(f.sel_cai_var(c('emergencia', 'consulta'), 'n'),\n                          f.sel_cai_var(c('taxa', 'pacote'), 's')) %>% \n  .[1:77,] %>% \n  cor(., method = 'pearson')\n\nf.cor_smst <- function(df,x,y) {\n  \n  tb = tibble(semestre = character(), corr = double())\n  \n  for(i in seq_along(df)) {\n    tb[i,] <- cbind(names(df)[i],df[[i]][x,y])\n  }\n  \n  return(tb)\n  \n}\n\nf.cor_cmpar <- function(df,dfcor,x,y) {\n  print(paste(x,y))\n  print('-----------------------------------------------------------')  \n  print(f.cor_smst(dfcor, x, y))\n  corr <- as.numeric(f.cor_smst(dfcor, x, y)$corr)\n  print('-----------------------------------------------------------')\n  print(paste0('Range:              ', range(corr)[1], ' > ', range(corr)[2]))\n  print(paste0('Prop(Max) Perc Var: ', round((range(corr)[2]-range(corr)[1])/range(corr)[2],4)*100))\n  print(paste0('Mean Corr:          ', mean(corr)))\n  print(paste0('Main Corr:          ', df[x, y]))\n  print(paste0('Delta Corr:         ', abs(mean(corr)-df[x, y])))\n  print(paste0('Var:                ', var(corr)))\n  print(paste0('DP:                 ', sd(corr)))\n  print('-----------------------------------------------------------')  \n  #plot(f.cor_smst(smst.corP, x, y)[,2])\n  #colnames(dfcor[[1]])\n}\n\n#----------------------------------------------------------------------------------\n\nsmstN.corP <- cai_df %>% \n  filter(internacao == 'n') %>% \n  arrange(amq) %>%  \n  split(.$semestre) %>% \n  map(f.tab_cor,'pearson')\n\nsmstS.corP <- cai_df %>% \n  filter(internacao == 's') %>% \n  arrange(amq) %>%  \n  split(.$semestre) %>% \n  map(f.tab_cor,'pearson')\n\nsmstN.corP\nsmstS.corP\n\nsmst_cross.corP <- cbind(f.sel_cai_var(c('emergencia', 'consulta'), 'n'),\n                    f.sel_cai_var(c('taxa', 'pacote','semestre'), 's')) %>%   \n  .[1:77,] %>% \n  split(.$semestre) %>%\n  map(select,-semestre) %>%\n  map(cor, method = 'pearson')\n\nsmst_cross.corP\n\n#----------------------------------------------------------------------------------\n\nf.cor_cmpar(caiN.corP,smstN.corP,'consulta','sadt')\nf.cor_cmpar(caiN.corP,smstN.corP,'sadt','pacote')\nf.cor_cmpar(caiN.corP,smstN.corP,'consulta','honorario')\nf.cor_cmpar(caiN.corP,smstN.corP,'honorario','medicamento')\n\nf.cor_cmpar(cai_ECn_PTs.corP,smst_cross.corP,'emergencia','taxa')\nf.cor_cmpar(cai_ECn_PTs.corP,smst_cross.corP,'consulta','pacote')\n\nf.cor_cmpar(caiS.corP,smstS.corP,'pacote','honorario')\nf.cor_cmpar(caiS.corP,smstS.corP,'taxa','honorario')\nf.cor_cmpar(caiS.corP,smstS.corP,'taxa','sadt')\nf.cor_cmpar(caiS.corP,smstS.corP,'taxa','material')\nf.cor_cmpar(caiS.corP,smstS.corP,'honorario','medicamento')\nf.cor_cmpar(caiS.corP,smstS.corP,'sadt','medicamento')\n\n#----------------------------------------------------------------------------------\n\nplot(f.cor_smst(smstS.corP, 'pacote','honorario')$corr ~ f.cor_smst(smstS.corP, 'pacote','honorario')$semestre)\nplot(f.cor_smst(smstS.corP, 'pacote','honorario')$semestre,\n     f.cor_smst(smstS.corP, 'pacote','honorario')$corr)\n\nfac <- f.cor_smst(smstS.corP, 'pacote','honorario')$semestre\ncorr <- f.cor_smst(smstS.corP, 'pacote','honorario')$corr\n\nplot(f.cor_smst(smstS.corP, 'pacote','honorario'))\nf.cor_smst(smstS.corP, 'pacote','honorario')\n\nplot(PlantGrowth)                                # -> plot.data.frame\nplot(weight ~ group, data = PlantGrowth)         # numeric vector ~ factor\n\n#facGG <- \nggplot(data = f.cor_smst(smstS.corP, 'pacote','honorario'),\n                aes(x = semestre, y = as.numeric(corr))) +\n  geom_point(col = 'orange', size = 3) +\n  geom_line(color = 'blue', size = 1, alpha = 0.5, group = 1) +\n  geom_hline(yintercept = 1, col = 'green', alpha = 0.3) +\n  geom_hline(yintercept = 0.75, col = 'red', alpha = 0.3) +    \n  geom_hline(yintercept = 0, col = 'black', alpha = 0.3) + \n  labs(title = 'Correlações Semestrais', x = 'Semestres', y = 'Correlação') + \n  scale_y_continuous(breaks = seq(-0.5, 1.1, by = 0.1)) +\n  coord_cartesian(ylim=c(-0.5, 1.1)) +\n  theme_bw()\n\n  plot(f.cor_smst(smstS.corP, 'pacote','honorario')$semestre,\n       f.cor_smst(smstS.corP, 'pacote','honorario')$corr,\n       type = 'o', \n       ylim=c(-0.5, 1),\n       col = 'blue',\n       ylab = \"Correlação\", \n       xlab = \"Observações no tempo (1/semestre, 2014-2017)\")\n  abline(h = 0, lty = 2)\n  abline(h = 1, lty = 2, col = 'green')  \n  abline(h = 0.75, lty = 2, col = 'red')  \n  \n  colnames(f.cor_smst(smstS.corP, 'pacote','honorario'))\n                     ",
    "created" : 1501791166240.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "2014699103",
    "id" : "655428BA",
    "lastKnownWriteTime" : 1502208162,
    "last_content_update" : 1502208162501,
    "path" : "~/R/Estudo_Componente_Geral/corr semestral.R",
    "project_path" : "corr semestral.R",
    "properties" : {
        "tempName" : "Untitled1"
    },
    "relative_order" : 2,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_source"
}