drv <- dbDriver("Oracle")
con <- dbConnect(drv, "ts_consulta", "ts_consulta", dbname='TS.INTRANET')
v_prest <- '594480'
v_ini <- '201601'
v_fim <- '201708'
View(x_tab_habilitacao)
View(x_tab_habilitacao)
View(x_tab_ben_vlr_apr)
names(x_tab_tratamento)
t_total <- x_tab_tratamento %>%
filter(str_sub(ANOMES,3,4) == 17) %>%
group_by(CODIGO, NOME, TRATAMENTO) %>%
summarise(BN = sum(BN), QUANTIDADE = sum(QUANTIDADE), VALOR = sum(VALOR), REVISAO = sum(REVISAO)) %>%
mutate(ANOMES = '2017_TOTAL')%>%
select(1:3, 8, 4:7) %>%
as.data.frame() %>%
rbind(., x_tab_tratamento)
tab_tratamento <- t_total %>%
gather(IND, VALOR, BN:REVISAO) %>%
group_by(CODIGO, NOME, TRATAMENTO) %>%
summarise(VALOR = sum(VALOR)) %>%
as.data.frame() %>%
mutate(ANOMES = paste0('C_',ANOMES)) %>%
unite(ANOMES_IND, c(ANOMES, IND)) %>%
spread(ANOMES_IND, VALOR) %>%
arrange(desc(C_2017_TOTAL_VALOR))
View(t_total)
t_total <- x_tab_tratamento %>%
filter(str_sub(ANOMES,3,4) == 17) %>%
group_by(CODIGO, NOME, TRATAMENTO) %>%
summarise(BN = sum(BN), QUANTIDADE = sum(QUANTIDADE), VALOR = sum(VALOR), REVISAO = sum(REVISAO)) %>%
mutate(ANOMES = '2017_TOTAL')%>%
select(1:3, 8, 4:7) %>%
as.data.frame() %>%
rbind(., x_tab_tratamento)
tab_tratamento <- t_total %>%
gather(IND, VALOR, BN:REVISAO) %>%
group_by(CODIGO, NOME, TRATAMENTO) %>%
summarise(VALOR = sum(VALOR)) %>%
as.data.frame() %>%
mutate(ANOMES = paste0('C_',ANOMES)) %>%
unite(ANOMES_IND, c(ANOMES, IND)) %>%
spread(ANOMES_IND, VALOR) %>%
arrange(desc(C_2017_TOTAL_VALOR))
t_total <- x_tab_detalhamento %>%
mutate(ESPECIALIDADE = ifelse(!is.na(match(x_tab_detalhamento$ESPECIALIDADE, x_dp_esp$banco)),
x_dp_esp[match(x_tab_detalhamento$ESPECIALIDADE, x_dp_esp$banco),1],
ESPECIALIDADE),
ITEM = ifelse(!is.na(match(x_tab_detalhamento$ITEM, x_dp_prc$banco)),
x_dp_prc[match(x_tab_detalhamento$ITEM, x_dp_prc$banco),1],
ITEM)) %>%
filter(str_sub(ANOMES,3,4) == 17) %>%
group_by(CODIGO, NOME, ESPECIALIDADE, ITEM, GRUPO) %>%
summarise(BN = sum(BN), QUANTIDADE = sum(QUANTIDADE), VALOR = sum(VALOR), REVISAO = sum(REVISAO)) %>%
mutate(ANOMES = '2017_TOTAL')%>%
select(1:5, 10, 6:9) %>%
as.data.frame() %>%
rbind(., x_tab_detalhamento)
tab_detalhamento <- t_total %>%
mutate(ESPECIALIDADE = ifelse(!is.na(match(t_total$ESPECIALIDADE, x_dp_esp$banco)),
x_dp_esp[match(t_total$ESPECIALIDADE, x_dp_esp$banco),1],
ESPECIALIDADE),
ITEM = ifelse(!is.na(match(t_total$ITEM, x_dp_prc$banco)),
x_dp_prc[match(t_total$ITEM, x_dp_prc$banco),1],
ITEM)) %>%
gather(IND, VALOR, BN:REVISAO) %>%
group_by(CODIGO, NOME, ESPECIALIDADE, ITEM, ANOMES, IND) %>%
summarise(VALOR = sum(VALOR)) %>%
as.data.frame() %>%
mutate(ANOMES = paste0('C_',ANOMES)) %>%
unite(ANOMES_IND, c(ANOMES, IND)) %>%
spread(ANOMES_IND, VALOR) %>%
arrange(desc(C_2017_TOTAL_VALOR))
t_total <- x_tab_tratamento %>%
filter(str_sub(ANOMES,3,4) == 17) %>%
group_by(CODIGO, NOME, TRATAMENTO) %>%
summarise(BN = sum(BN), QUANTIDADE = sum(QUANTIDADE), VALOR = sum(VALOR), REVISAO = sum(REVISAO)) %>%
mutate(ANOMES = '2017_TOTAL')%>%
select(1:3, 8, 4:7) %>%
as.data.frame() %>%
rbind(., x_tab_tratamento)
tab_tratamento <- t_total %>%
gather(IND, VALOR, BN:REVISAO) %>%
group_by(CODIGO, NOME, TRATAMENTO) %>%
summarise(VALOR = sum(VALOR)) %>%
as.data.frame() %>%
mutate(ANOMES = paste0('C_',ANOMES)) %>%
unite(ANOMES_IND, c(ANOMES, IND)) %>%
spread(ANOMES_IND, VALOR) %>%
arrange(desc(C_2017_TOTAL_VALOR))
tab_tratamento <- t_total %>%
gather(IND, VALOR, BN:REVISAO) %>%
group_by(CODIGO, NOME, TRATAMENTO) %>%
summarise(VALOR = sum(VALOR)) %>%
as.data.frame() %>%
mutate(ANOMES = paste0('C_',ANOMES)) #%>%
View(t_total)
tab_tratamento <- t_total %>%
gather(IND, VALOR, BN:REVISAO) %>%
group_by(CODIGO, NOME, TRATAMENTO, ANOMES, IND) %>%
summarise(VALOR = sum(VALOR)) %>%
as.data.frame() %>%
mutate(ANOMES = paste0('C_',ANOMES)) %>%
unite(ANOMES_IND, c(ANOMES, IND)) %>%
spread(ANOMES_IND, VALOR) %>%
arrange(desc(C_2017_TOTAL_VALOR))
t_total <- x_tab_tratamento %>%
filter(str_sub(ANOMES,3,4) == 17) %>%
group_by(CODIGO, NOME, TRATAMENTO) %>%
summarise(BN = sum(BN), QUANTIDADE = sum(QUANTIDADE), VALOR = sum(VALOR), REVISAO = sum(REVISAO)) %>%
mutate(ANOMES = '2017_TOTAL')%>%
select(1:3, 8, 4:7) %>%
as.data.frame() %>%
rbind(., x_tab_tratamento)
tab_tratamento <- t_total %>%
gather(IND, VALOR, BN:REVISAO) %>%
group_by(CODIGO, NOME, TRATAMENTO, ANOMES, IND) %>%
summarise(VALOR = sum(VALOR)) %>%
as.data.frame() %>%
mutate(ANOMES = paste0('C_',ANOMES)) %>%
unite(ANOMES_IND, c(ANOMES, IND)) %>%
spread(ANOMES_IND, VALOR) %>%
arrange(desc(C_2017_TOTAL_VALOR))
names(x_tab_especialidade)
t_total <- x_tab_detalhamento %>%
mutate(ESPECIALIDADE = ifelse(!is.na(match(x_tab_detalhamento$ESPECIALIDADE, x_dp_esp$banco)),
x_dp_esp[match(x_tab_detalhamento$ESPECIALIDADE, x_dp_esp$banco),1],
ESPECIALIDADE),
ITEM = ifelse(!is.na(match(x_tab_detalhamento$ITEM, x_dp_prc$banco)),
x_dp_prc[match(x_tab_detalhamento$ITEM, x_dp_prc$banco),1],
ITEM)) %>%
filter(str_sub(ANOMES,3,4) == 17) %>%
group_by(CODIGO, NOME, ESPECIALIDADE, ITEM, GRUPO) %>%
summarise(BN = sum(BN), QUANTIDADE = sum(QUANTIDADE), VALOR = sum(VALOR), REVISAO = sum(REVISAO)) %>%
mutate(ANOMES = '2017_TOTAL')%>%
select(1:5, 10, 6:9) %>%
as.data.frame() %>%
rbind(., x_tab_detalhamento)
tab_detalhamento <- t_total %>%
mutate(ESPECIALIDADE = ifelse(!is.na(match(t_total$ESPECIALIDADE, x_dp_esp$banco)),
x_dp_esp[match(t_total$ESPECIALIDADE, x_dp_esp$banco),1],
ESPECIALIDADE),
ITEM = ifelse(!is.na(match(t_total$ITEM, x_dp_prc$banco)),
x_dp_prc[match(t_total$ITEM, x_dp_prc$banco),1],
ITEM)) %>%
gather(IND, VALOR, BN:REVISAO) %>%
group_by(CODIGO, NOME, ESPECIALIDADE, ITEM, GRUPO, ANOMES, IND) %>%
summarise(VALOR = sum(VALOR)) %>%
as.data.frame() %>%
mutate(ANOMES = paste0('C_',ANOMES)) %>%
unite(ANOMES_IND, c(ANOMES, IND)) %>%
spread(ANOMES_IND, VALOR) %>%
arrange(desc(C_2017_TOTAL_VALOR))
t_total <- x_tab_especialidade %>%
mutate(ESPECIALIDADE = ifelse(!is.na(match(x_tab_especialidade$ESPECIALIDADE, x_dp_esp$banco)),
x_dp_esp[match(x_tab_especialidade$ESPECIALIDADE, x_dp_esp$banco),1],
ESPECIALIDADE)) %>%
filter(str_sub(ANOMES,3,4) == 17) %>%
group_by(CODIGO, NOME, ESPECIALIDADE) %>%
summarise(BN = sum(BN), QUANTIDADE = sum(QUANTIDADE), VALOR = sum(VALOR), REVISAO = sum(REVISAO)) %>%
mutate(ANOMES = '2017_TOTAL')%>%
select(1:3, 8, 4:7) %>%
as.data.frame() %>%
rbind(., x_tab_especialidade)
tab_especialidade <- t_total %>%
mutate(ESPECIALIDADE = ifelse(!is.na(match(t_total$ESPECIALIDADE, x_dp_esp$banco)),
x_dp_esp[match(t_total$ESPECIALIDADE, x_dp_esp$banco),1],
ESPECIALIDADE)) %>%
gather(IND, VALOR, BN:REVISAO) %>%
group_by(CODIGO, NOME, ESPECIALIDADE, ANOMES, IND) %>%
summarise(VALOR = sum(VALOR)) %>%
as.data.frame() %>%
mutate(ANOMES = paste0('C_',ANOMES)) %>%
unite(ANOMES_IND, c(ANOMES, IND)) %>%
spread(ANOMES_IND, VALOR) %>%
arrange(desc(C_2017_TOTAL_VALOR))
t_total <- x_tab_tratamento %>%
filter(str_sub(ANOMES,3,4) == 17) %>%
group_by(CODIGO, NOME, TRATAMENTO) %>%
summarise(BN = sum(BN), QUANTIDADE = sum(QUANTIDADE), VALOR = sum(VALOR), REVISAO = sum(REVISAO)) %>%
mutate(ANOMES = '2017_TOTAL')%>%
select(1:3, 8, 4:7) %>%
as.data.frame() %>%
rbind(., x_tab_tratamento)
tab_tratamento <- t_total %>%
gather(IND, VALOR, BN:REVISAO) %>%
group_by(CODIGO, NOME, TRATAMENTO, ANOMES, IND) %>%
summarise(VALOR = sum(VALOR)) %>%
as.data.frame() %>%
mutate(ANOMES = paste0('C_',ANOMES)) %>%
unite(ANOMES_IND, c(ANOMES, IND)) %>%
spread(ANOMES_IND, VALOR) %>%
arrange(desc(C_2017_TOTAL_VALOR))
t_total <- x_tab_especialidade %>%
mutate(ESPECIALIDADE = ifelse(!is.na(match(x_tab_especialidade$ESPECIALIDADE, x_dp_esp$banco)),
x_dp_esp[match(x_tab_especialidade$ESPECIALIDADE, x_dp_esp$banco),1],
ESPECIALIDADE)) %>%
filter(str_sub(ANOMES,3,4) == 17) %>%
group_by(CODIGO, NOME, ESPECIALIDADE) %>%
summarise(BN = sum(BN), QUANTIDADE = sum(QUANTIDADE), VALOR = sum(VALOR), REVISAO = sum(REVISAO)) %>%
mutate(ANOMES = '2017_TOTAL')%>%
select(1:3, 8, 4:7) %>%
as.data.frame() %>%
rbind(., x_tab_especialidade)
tab_especialidade <- t_total %>%
mutate(ESPECIALIDADE = ifelse(!is.na(match(t_total$ESPECIALIDADE, x_dp_esp$banco)),
x_dp_esp[match(t_total$ESPECIALIDADE, x_dp_esp$banco),1],
ESPECIALIDADE)) %>%
gather(IND, VALOR, BN:REVISAO) %>%
group_by(CODIGO, NOME, ESPECIALIDADE, ANOMES, IND) %>%
summarise(VALOR = sum(VALOR)) %>%
as.data.frame() %>%
mutate(ANOMES = paste0('C_',ANOMES)) %>%
unite(ANOMES_IND, c(ANOMES, IND)) %>%
spread(ANOMES_IND, VALOR) %>%
arrange(desc(C_2017_TOTAL_VALOR))
t_total <- x_tab_detalhamento %>%
mutate(ESPECIALIDADE = ifelse(!is.na(match(x_tab_detalhamento$ESPECIALIDADE, x_dp_esp$banco)),
x_dp_esp[match(x_tab_detalhamento$ESPECIALIDADE, x_dp_esp$banco),1],
ESPECIALIDADE),
ITEM = ifelse(!is.na(match(x_tab_detalhamento$ITEM, x_dp_prc$banco)),
x_dp_prc[match(x_tab_detalhamento$ITEM, x_dp_prc$banco),1],
ITEM)) %>%
filter(str_sub(ANOMES,3,4) == 17) %>%
group_by(CODIGO, NOME, ESPECIALIDADE, ITEM, GRUPO) %>%
summarise(BN = sum(BN), QUANTIDADE = sum(QUANTIDADE), VALOR = sum(VALOR), REVISAO = sum(REVISAO)) %>%
mutate(ANOMES = '2017_TOTAL')%>%
select(1:5, 10, 6:9) %>%
as.data.frame() %>%
rbind(., x_tab_detalhamento)
tab_detalhamento <- t_total %>%
mutate(ESPECIALIDADE = ifelse(!is.na(match(t_total$ESPECIALIDADE, x_dp_esp$banco)),
x_dp_esp[match(t_total$ESPECIALIDADE, x_dp_esp$banco),1],
ESPECIALIDADE),
ITEM = ifelse(!is.na(match(t_total$ITEM, x_dp_prc$banco)),
x_dp_prc[match(t_total$ITEM, x_dp_prc$banco),1],
ITEM)) %>%
gather(IND, VALOR, BN:REVISAO) %>%
group_by(CODIGO, NOME, ESPECIALIDADE, ITEM, GRUPO, ANOMES, IND) %>%
summarise(VALOR = sum(VALOR)) %>%
as.data.frame() %>%
mutate(ANOMES = paste0('C_',ANOMES)) %>%
unite(ANOMES_IND, c(ANOMES, IND)) %>%
spread(ANOMES_IND, VALOR) %>%
arrange(desc(C_2017_TOTAL_VALOR))
names(x_tab_itens)
t_total <- x_tab_itens %>%
mutate(ITEM = ifelse(!is.na(match(x_tab_itens$ITEM, x_dp_prc$banco)),
x_dp_prc[match(x_tab_itens$ITEM, x_dp_prc$banco),1],
ITEM)) %>%
filter(str_sub(ANOMES,3,4) == 17) %>%
group_by(CODIGO, NOME, ITEM_MEDICO, ITEM) %>%
summarise(BN = sum(BN), QUANTIDADE = sum(QUANTIDADE), VALOR = sum(VALOR), REVISAO = sum(REVISAO)) %>%
mutate(ANOMES = '2017_TOTAL')%>%
select(1:4, 9, 5:8) %>%
as.data.frame() %>%
rbind(., x_tab_itens)
tab_itens <- t_total %>%
mutate(ITEM = ifelse(!is.na(match(t_total$ITEM, x_dp_prc$banco)),
x_dp_prc[match(t_total$ITEM, x_dp_prc$banco),1],
ITEM)) %>%
gather(IND, VALOR, BN:REVISAO) %>%
group_by(CODIGO, NOME, ITEM_MEDICO, ITEM, ANOMES, IND) %>%
summarise(VALOR = sum(VALOR)) %>%
as.data.frame() %>%
mutate(ANOMES = paste0('C_',ANOMES)) %>%
unite(ANOMES_IND, c(ANOMES, IND)) %>%
spread(ANOMES_IND, VALOR) %>%
arrange(desc(C_2017_TOTAL_VALOR))
x_tab_cotas
View(tab_itens)
View(tab_detalhamento)
t1 <- x_tab_detalhamento %>%
mutate(ESPECIALIDADE = ifelse(!is.na(match(x_tab_detalhamento$ESPECIALIDADE, x_dp_esp$banco)),
x_dp_esp[match(x_tab_detalhamento$ESPECIALIDADE, x_dp_esp$banco),1],
ESPECIALIDADE),
ITEM = ifelse(!is.na(match(x_tab_detalhamento$ITEM, x_dp_prc$banco)),
x_dp_prc[match(x_tab_detalhamento$ITEM, x_dp_prc$banco),1],
ITEM)) %>%
filter(str_sub(ANOMES,3,4) == 17) %>%
group_by(CODIGO, NOME, ESPECIALIDADE, ITEM, GRUPO) %>%
summarise(BN = sum(BN), QUANTIDADE = sum(QUANTIDADE), VALOR = sum(VALOR), REVISAO = sum(REVISAO)) %>%
mutate(ANOMES = 'TOTAL_2017')%>%
select(1:5, 10, 6:9) %>%
as.data.frame() %>%
rbind(., x_tab_detalhamento) %>%
mutate(ESPECIALIDADE = ifelse(!is.na(match(t_total$ESPECIALIDADE, x_dp_esp$banco)),
x_dp_esp[match(t_total$ESPECIALIDADE, x_dp_esp$banco),1],
ESPECIALIDADE),
ITEM = ifelse(!is.na(match(t_total$ITEM, x_dp_prc$banco)),
x_dp_prc[match(t_total$ITEM, x_dp_prc$banco),1],
ITEM)) %>%
gather(IND, VALOR, BN:REVISAO) %>%
group_by(CODIGO, NOME, ESPECIALIDADE, ITEM, ANOMES, IND) %>%
summarise(VALOR = sum(VALOR)) %>%
unite(ANOMES_IND, c(IND, ANOMES)) %>%
spread(ANOMES_IND, VALOR) %>%
as.data.frame()%<>%
arrange(desc(VALOR_TOTAL_2017))
t1 <- x_tab_detalhamento %>%
mutate(ESPECIALIDADE = ifelse(!is.na(match(x_tab_detalhamento$ESPECIALIDADE, x_dp_esp$banco)),
x_dp_esp[match(x_tab_detalhamento$ESPECIALIDADE, x_dp_esp$banco),1],
ESPECIALIDADE),
ITEM = ifelse(!is.na(match(x_tab_detalhamento$ITEM, x_dp_prc$banco)),
x_dp_prc[match(x_tab_detalhamento$ITEM, x_dp_prc$banco),1],
ITEM)) %>%
filter(str_sub(ANOMES,3,4) == 17) %>%
group_by(CODIGO, NOME, ESPECIALIDADE, ITEM, GRUPO) %>%
summarise(BN = sum(BN), QUANTIDADE = sum(QUANTIDADE), VALOR = sum(VALOR), REVISAO = sum(REVISAO)) %>%
mutate(ANOMES = 'TOTAL_2017')%>%
select(1:5, 10, 6:9) %>%
as.data.frame() %>%
rbind(., x_tab_detalhamento) %>%
mutate(ESPECIALIDADE = ifelse(!is.na(match(.$ESPECIALIDADE, x_dp_esp$banco)),
x_dp_esp[match(.$ESPECIALIDADE, x_dp_esp$banco),1],
ESPECIALIDADE),
ITEM = ifelse(!is.na(match(.$ITEM, x_dp_prc$banco)),
x_dp_prc[match(.$ITEM, x_dp_prc$banco),1],
ITEM)) %>%
gather(IND, VALOR, BN:REVISAO) %>%
group_by(CODIGO, NOME, ESPECIALIDADE, ITEM, ANOMES, IND) %>%
summarise(VALOR = sum(VALOR)) %>%
unite(ANOMES_IND, c(IND, ANOMES)) %>%
spread(ANOMES_IND, VALOR) %>%
as.data.frame()%<>%
arrange(desc(VALOR_TOTAL_2017))
View(t1)
t1 <- x_tab_detalhamento %>%
mutate(ESPECIALIDADE = ifelse(!is.na(match(x_tab_detalhamento$ESPECIALIDADE, x_dp_esp$banco)),
x_dp_esp[match(x_tab_detalhamento$ESPECIALIDADE, x_dp_esp$banco),1],
ESPECIALIDADE),
ITEM = ifelse(!is.na(match(x_tab_detalhamento$ITEM, x_dp_prc$banco)),
x_dp_prc[match(x_tab_detalhamento$ITEM, x_dp_prc$banco),1],
ITEM)) %>%
filter(str_sub(ANOMES,3,4) == 17) %>%
group_by(CODIGO, NOME, ESPECIALIDADE, ITEM, GRUPO) %>%
summarise(BN = sum(BN), QUANTIDADE = sum(QUANTIDADE), VALOR = sum(VALOR), REVISAO = sum(REVISAO)) %>%
mutate(ANOMES = '2017_TOTAL')%>%
select(1:5, 10, 6:9) %>%
as.data.frame() %>%
rbind(., x_tab_detalhamento) %>%
mutate(ESPECIALIDADE = ifelse(!is.na(match(.$ESPECIALIDADE, x_dp_esp$banco)),
x_dp_esp[match(.$ESPECIALIDADE, x_dp_esp$banco),1],
ESPECIALIDADE),
ITEM = ifelse(!is.na(match(.$ITEM, x_dp_prc$banco)),
x_dp_prc[match(.$ITEM, x_dp_prc$banco),1],
ITEM)) %>%
gather(IND, VALOR, BN:REVISAO) %>%
group_by(CODIGO, NOME, ESPECIALIDADE, ITEM, GRUPO, ANOMES, IND) %>%
summarise(VALOR = sum(VALOR)) %>%
as.data.frame() %>%
mutate(ANOMES = paste0('C_',ANOMES)) %>%
unite(ANOMES_IND, c(ANOMES, IND)) %>%
spread(ANOMES_IND, VALOR) %>%
arrange(desc(C_2017_TOTAL_VALOR))
View(t1)
names(x_tab_ben_vlr_apr)
names(x_tab_cotas)
tab_cotas <- merge(x_tab_cotas, x_tab_ben_vlr_apr, by = 'ANOMES')
names(tab_cotas)
View(x_tab_cotas)
names(x_tab_ben_vlr_apr)
names(x_tab_cotas)
tab_cotas <- merge(x_tab_cotas, x_tab_ben_vlr_apr, by = 'ANOMES') %>%
select()
names(tab_cotas)
tab_cotas <- merge(x_tab_cotas, x_tab_ben_vlr_apr, by = 'ANOMES') #%>%
names(tab_cotas)
tab_cotas <- merge(x_tab_cotas, x_tab_ben_vlr_apr, by = 'ANOMES') %>%
select(1:4, 10, 5)
names(tab_cotas)
tab_cotas <- merge(x_tab_cotas, x_tab_ben_vlr_apr, by = 'ANOMES') %>%
select(1:4, VALOR_APROVADO = VALOR, 5)
names(tab_cotas)
View(tab_cotas)
## Opções iniciais de configuração do ambiente
# ------------------------------------------------------------------------------------------
knitr::opts_chunk$set(echo = TRUE)
options(scipen=999)
# ------------------------------------------------------------------------------------------
library("stringr", lib.loc="~/R/win-library/3.4")
library("dplyr", lib.loc="~/R/win-library/3.4")
library("ggplot2", lib.loc="~/R/win-library/3.4")
library("readr", lib.loc="~/R/win-library/3.4")
library("tibble", lib.loc="~/R/win-library/3.4")
library("tidyr", lib.loc="~/R/win-library/3.4")
library("magrittr", lib.loc="~/R/win-library/3.4")
library("readxl", lib.loc="~/R/win-library/3.4")
library("purrr", lib.loc="~/R/win-library/3.4")
library("knitr", lib.loc="~/R/win-library/3.4")
library("DBI", lib.loc="~/R/win-library/3.4")
library("ROracle", lib.loc="~/R/win-library/3.4")
# ------------------------------------------------------------------------------------------
drv <- dbDriver("Oracle")
con <- dbConnect(drv, "ts_consulta", "ts_consulta", dbname='TS.INTRANET')
v_prest <- '594480'
v_ini <- '201601'
v_fim <- '201708'
##-----------------------------------------------------------------------------------------------------
x_dp_esp <- read_excel('de_para_esp.xlsx') %>%
as.data.frame()
x_dp_prc <- read_excel('de_para_proc.xlsx') %>%
as.data.frame()
##-----------------------------------------------------------------------------------------------------
##-----------------------------------------------------------------------------------------------------
write.csv2(x_tab_habilitacao, 'tab_habilitacao.csv')
##-----------------------------------------------------------------------------------------------------
write.csv2(x_tab_ben_vlr_apr, 'tab_ben_vlr_apr.csv')
##-----------------------------------------------------------------------------------------------------
tab_tratamento <- x_tab_tratamento %>%
filter(str_sub(ANOMES,3,4) == 17) %>%
group_by(CODIGO, NOME, TRATAMENTO) %>%
summarise(BN = sum(BN), QUANTIDADE = sum(QUANTIDADE), VALOR = sum(VALOR), REVISAO = sum(REVISAO)) %>%
mutate(ANOMES = '2017_TOTAL')%>%
select(1:3, 8, 4:7) %>%
as.data.frame() %>%
rbind(., x_tab_tratamento) %>%
gather(IND, VALOR, BN:REVISAO) %>%
group_by(CODIGO, NOME, TRATAMENTO, ANOMES, IND) %>%
summarise(VALOR = sum(VALOR)) %>%
as.data.frame() %>%
mutate(ANOMES = paste0('C_',ANOMES)) %>%
unite(ANOMES_IND, c(ANOMES, IND)) %>%
spread(ANOMES_IND, VALOR) %>%
arrange(desc(C_2017_TOTAL_VALOR))
write.csv2(tab_tratamento, 'tab_tratamento.csv')
##-----------------------------------------------------------------------------------------------------
tab_especialidade <- x_tab_especialidade %>%
mutate(ESPECIALIDADE = ifelse(!is.na(match(x_tab_especialidade$ESPECIALIDADE, x_dp_esp$banco)),
x_dp_esp[match(x_tab_especialidade$ESPECIALIDADE, x_dp_esp$banco),1],
ESPECIALIDADE)) %>%
filter(str_sub(ANOMES,3,4) == 17) %>%
group_by(CODIGO, NOME, ESPECIALIDADE) %>%
summarise(BN = sum(BN), QUANTIDADE = sum(QUANTIDADE), VALOR = sum(VALOR), REVISAO = sum(REVISAO)) %>%
mutate(ANOMES = '2017_TOTAL')%>%
select(1:3, 8, 4:7) %>%
as.data.frame() %>%
rbind(., x_tab_especialidade) %>%
mutate(ESPECIALIDADE = ifelse(!is.na(match(.$ESPECIALIDADE, x_dp_esp$banco)),
x_dp_esp[match(.$ESPECIALIDADE, x_dp_esp$banco),1],
ESPECIALIDADE)) %>%
gather(IND, VALOR, BN:REVISAO) %>%
group_by(CODIGO, NOME, ESPECIALIDADE, ANOMES, IND) %>%
summarise(VALOR = sum(VALOR)) %>%
as.data.frame() %>%
mutate(ANOMES = paste0('C_',ANOMES)) %>%
unite(ANOMES_IND, c(ANOMES, IND)) %>%
spread(ANOMES_IND, VALOR) %>%
arrange(desc(C_2017_TOTAL_VALOR))
write.csv2(tab_especialidade, 'tab_especialidade.csv')
##-----------------------------------------------------------------------------------------------------
tab_detalhamento <- x_tab_detalhamento %>%
mutate(ESPECIALIDADE = ifelse(!is.na(match(x_tab_detalhamento$ESPECIALIDADE, x_dp_esp$banco)),
x_dp_esp[match(x_tab_detalhamento$ESPECIALIDADE, x_dp_esp$banco),1],
ESPECIALIDADE),
ITEM = ifelse(!is.na(match(x_tab_detalhamento$ITEM, x_dp_prc$banco)),
x_dp_prc[match(x_tab_detalhamento$ITEM, x_dp_prc$banco),1],
ITEM)) %>%
filter(str_sub(ANOMES,3,4) == 17) %>%
group_by(CODIGO, NOME, ESPECIALIDADE, ITEM, GRUPO) %>%
summarise(BN = sum(BN), QUANTIDADE = sum(QUANTIDADE), VALOR = sum(VALOR), REVISAO = sum(REVISAO)) %>%
mutate(ANOMES = '2017_TOTAL')%>%
select(1:5, 10, 6:9) %>%
as.data.frame() %>%
rbind(., x_tab_detalhamento) %>%
mutate(ESPECIALIDADE = ifelse(!is.na(match(.$ESPECIALIDADE, x_dp_esp$banco)),
x_dp_esp[match(.$ESPECIALIDADE, x_dp_esp$banco),1],
ESPECIALIDADE),
ITEM = ifelse(!is.na(match(.$ITEM, x_dp_prc$banco)),
x_dp_prc[match(.$ITEM, x_dp_prc$banco),1],
ITEM)) %>%
gather(IND, VALOR, BN:REVISAO) %>%
group_by(CODIGO, NOME, ESPECIALIDADE, ITEM, GRUPO, ANOMES, IND) %>%
summarise(VALOR = sum(VALOR)) %>%
as.data.frame() %>%
mutate(ANOMES = paste0('C_',ANOMES)) %>%
unite(ANOMES_IND, c(ANOMES, IND)) %>%
spread(ANOMES_IND, VALOR) %>%
arrange(desc(C_2017_TOTAL_VALOR))
write.csv2(tab_detalhamento, 'tab_detalhamento.csv')
##-----------------------------------------------------------------------------------------------------
tab_itens <- x_tab_itens %>%
mutate(ITEM = ifelse(!is.na(match(x_tab_itens$ITEM, x_dp_prc$banco)),
x_dp_prc[match(x_tab_itens$ITEM, x_dp_prc$banco),1],
ITEM)) %>%
filter(str_sub(ANOMES,3,4) == 17) %>%
group_by(CODIGO, NOME, ITEM_MEDICO, ITEM) %>%
summarise(BN = sum(BN), QUANTIDADE = sum(QUANTIDADE), VALOR = sum(VALOR), REVISAO = sum(REVISAO)) %>%
mutate(ANOMES = '2017_TOTAL')%>%
select(1:4, 9, 5:8) %>%
as.data.frame() %>%
rbind(., x_tab_itens) %>%
mutate(ITEM = ifelse(!is.na(match(.$ITEM, x_dp_prc$banco)),
x_dp_prc[match(.$ITEM, x_dp_prc$banco),1],
ITEM)) %>%
gather(IND, VALOR, BN:REVISAO) %>%
group_by(CODIGO, NOME, ITEM_MEDICO, ITEM, ANOMES, IND) %>%
summarise(VALOR = sum(VALOR)) %>%
as.data.frame() %>%
mutate(ANOMES = paste0('C_',ANOMES)) %>%
unite(ANOMES_IND, c(ANOMES, IND)) %>%
spread(ANOMES_IND, VALOR) %>%
arrange(desc(C_2017_TOTAL_VALOR))
write.csv2(tab_itens, 'tab_itens.csv')
##-----------------------------------------------------------------------------------------------------
tab_cotas <- merge(x_tab_cotas, x_tab_ben_vlr_apr, by = 'ANOMES') %>%
select(1:4, VALOR_APROVADO = VALOR, 5)
write.csv2(tab_cotas, 'tab_cotas.csv')
##-----------------------------------------------------------------------------------------------------
install.packages(c("backports", "crayon", "curl", "data.table", "dplyr", "openssl", "orcutt", "psych", "purrr", "quantmod", "Rcpp", "rsm", "SixSigma", "tidyr", "tidyselect"))
install.packages("data.table")
install.packages("data.table")
